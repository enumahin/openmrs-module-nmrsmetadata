--liquibase formatted sql
--changeset wande:nmrs_patientflags_flag splitStatements:true endDelimiter:;
INSERT IGNORE INTO `patientflags_flag` VALUES
(1,'No HIV Diagnosis Date','select distinct patient_id\nfrom patient p\nwhere (select value_datetime from obs where concept_id = 160554 and person_id = p.patient_id limit 1) is null and p.voided is null','Patient has no HIV Diagnosis date recorded',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 09:32:37',1,'2020-07-15 14:55:20',0,NULL,NULL,NULL,'19208809-c2e2-46f8-96a3-0b853988417d',1),
(2,'No HIV Enrollment Date','select distinct patient_id from patient p\nwhere (select encounter_datetime from encounter where encounter_type = 14 and patient_id = p.patient_id limit 1) is null and p.voided is null','Patient has no HIV Enrollment Date Recorded',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 09:34:24',1,'2020-07-15 14:55:29',0,NULL,NULL,NULL,'bde08bc9-e0da-41c3-aed2-d8948c5c3147',1),
(3,'No Address/LGA Documented','select p.patient_id, pd.address1,pd.city_village \nfrom patient p \njoin person_address pd on p.patient_id = pd.person_id  \nwhere pd.address1 is null and pd.city_village is null and p.voided is null','No Address/LGA Documented',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 09:43:08',1,'2019-10-11 09:59:06',0,NULL,NULL,NULL,'32d00137-fe52-4596-ab79-e8c9c9e54515',1),
(4,'Patient Started ART but with no documented ART Regimen','select * from patient p \nwhere p.patient_id in (select distinct person_id from obs b join encounter e on e.encounter_id = b.encounter_id\nwhere b.concept_id = 159599) and p.patient_id not in (select distinct person_id from obs b join encounter e on e.encounter_id = b.encounter_id\nwhere e.encounter_type = 13 and b.concept_id in (164506,164513,165702,164507,164514,165703)) and p.voided is null','Started ART but no documented ART Regimen',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 09:48:38',1,'2019-11-06 20:59:25',0,NULL,NULL,NULL,'8c9cd66c-05ae-4601-8dfa-92df7a18e798',1),
(5,'No Documented Weight in Last Clinical Visit','SELECT p.patient_id\nFROM patient p,\n     encounter e\nWHERE p.patient_id IN\n    (SELECT o.person_id AS patient_id\n     FROM obs o\n     WHERE o.encounter_id = e.encounter_id\n     HAVING FIND_IN_SET(\'5089\', GROUP_CONCAT(DISTINCT(o.concept_id) SEPARATOR \',\')) = 0)\n  AND p.patient_id IN\n    (SELECT e2.patient_id\n     FROM encounter e2\n     WHERE e.encounter_id = e2.encounter_id\n       AND e2.encounter_type = 12\n       AND e2.encounter_datetime BETWEEN date_add(now(),
 interval -6 MONTH) AND now()\n     HAVING MAX(e2.encounter_datetime))\n  AND e.patient_id = p.patient_id','No Documented Weight in Last Clinical Visit',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 09:49:15',1,'2020-07-15 14:55:10',0,NULL,NULL,NULL,'4a0d0590-5774-4386-aea3-5f13ed8d1ae7',1),
(6,'Ped Patient without Last MUAC','SELECT p.patient_id\nFROM patient p\nWHERE p.patient_id IN\n    (SELECT person_id patient_id\n     FROM obs\n     WHERE person_id = p.patient_id\n     HAVING FIND_IN_SET(\'165935\', GROUP_CONCAT((concept_id) SEPARATOR \',\')) = 0\n     OR FIND_IN_SET(\'165243\', GROUP_CONCAT((concept_id) SEPARATOR \',\')) = 0)\n  AND p.patient_id IN\n    (SELECT e.patient_id\n     FROM encounter e,\n          person pe\n     WHERE e.encounter_datetime BETWEEN date_add(now(),
 interval -6 MONTH) AND now()\n       AND datediff(e.encounter_datetime, pe.birthdate)/365 <= 5\n       AND e.encounter_type = 12\n       AND e.patient_id = p.patient_id\n       AND e.patient_id = pe.person_id\n     HAVING MAX(e.encounter_datetime))','No Documented MUAC in Last Visit',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 09:49:58',1,'2020-07-15 14:56:28',0,NULL,NULL,NULL,'abc9e1a2-acd5-49ae-a79e-ea08137e88e3',1),
(7,'Have no Documented WHO in Last Clinical Visit','SELECT p.patient_id\nFROM patient p,\n     encounter e\nWHERE p.patient_id IN\n    (SELECT o.person_id AS patient_id\n     FROM obs o\n     WHERE o.encounter_id = e.encounter_id\n     HAVING FIND_IN_SET(\'5356\', GROUP_CONCAT(DISTINCT(o.concept_id) SEPARATOR \',\')) = 0)\n  AND p.patient_id IN\n    (SELECT e2.patient_id\n     FROM encounter e2\n     WHERE e.encounter_id = e2.encounter_id\n       AND e2.encounter_type = 12\n       AND e2.encounter_datetime BETWEEN date_add(now(),
 interval -6 MONTH) AND now()\n     HAVING MAX(e2.encounter_datetime))\n  AND e.patient_id = p.patient_id','Have no Documented WHO in Last Clinical Visit',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 09:52:14',1,'2020-07-15 14:54:51',0,NULL,NULL,NULL,'f0c645e9-f1cd-4546-9476-7291614cf619',1),
(8,'Patient with no documented TB Status in last clinical visit','SELECT p.patient_id\nFROM patient p,\n     encounter e\nWHERE p.patient_id IN\n    (SELECT o.person_id AS patient_id\n     FROM obs o\n     WHERE o.encounter_id = e.encounter_id\n     HAVING FIND_IN_SET(\'1659\', GROUP_CONCAT(DISTINCT(o.concept_id) SEPARATOR \',\')) = 0)\n  AND p.patient_id IN\n    (SELECT e2.patient_id\n     FROM encounter e2\n     WHERE e.encounter_id = e2.encounter_id\n       AND e2.encounter_type = 12\n       AND e2.encounter_datetime BETWEEN date_add(now(),
 interval -6 MONTH) AND now()\n     HAVING MAX(e2.encounter_datetime))\n  AND e.patient_id = p.patient_id','Patient with no documented TB Status in last clinical visit',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 09:54:07',1,'2020-07-15 14:55:47',0,NULL,NULL,NULL,'64dc1a09-7ce0-4175-97e4-93b5ed08b936',1),
(9,'Dead without documented date of death','select p.patient_id from patient p join obs b on p.patient_id = b.person_id where patient_id in\n(select b.person_id patient_id from obs b where b.concept_id = 165470 and b.value_coded = 165889)\nand p.patient_id in \n(select bb.person_id as patient_id from obs bb where bb.concept_id = 165469 and bb.value_datetime is null ) \ngroup by p.patient_id;','Recorded as Dead Without Documented Date of Death',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 09:55:54',1,'2020-07-15 14:54:26',0,NULL,NULL,NULL,'5282bb1a-3f97-4021-aeab-7eff03ef4c4c',1),
(10,'Patient with regimen but no drug refill duration','SELECT p.patient_id\nFROM patient p,\n     encounter e\nWHERE p.patient_id IN\n    (SELECT person_id patient_id\n     FROM obs\n     WHERE person_id = p.patient_id\n       AND concept_id IN (164506,\n                          164513,\n                          165702,\n                          164507,\n                          164514,\n                          165703)\n     ORDER BY obs_datetime)\n  AND p.patient_id NOT IN\n    (SELECT person_id patient_id\n     FROM obs\n     WHERE person_id = p.patient_id\n       AND concept_id = 159368\n     ORDER BY obs_datetime)\n  AND p.patient_id = e.patient_id\n  AND e.encounter_type = 14','Patient with regimen but no drug refill duration',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 11:39:21',1,'2020-07-15 14:55:57',0,NULL,NULL,NULL,'a20784cb-3587-4d13-91c7-cc0058ef92b7',1),
(11,'Patient without documented VL in last 12 months','SELECT p.patient_id\nFROM patient p\nWHERE p.patient_id IN\n    (SELECT DISTINCT e.patient_id\n     FROM encounter e\n     WHERE p.patient_id = e.patient_id\n       AND e.encounter_type = 11\n     ORDER BY encounter_datetime DESC)\n  AND p.patient_id IN\n    (SELECT person_id patient_id\n     FROM obs\n     WHERE concept_id = 159951\n     AND person_id = p.patient_id\n     GROUP BY person_id\n     HAVING TIMESTAMPDIFF(MONTH, max(value_datetime),
 curdate()) >= 12)','Have No Documented VL in Last 12 Months',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-27 11:45:26',1,'2020-07-15 14:56:20',0,NULL,NULL,NULL,'0982b200-0075-4f05-92fe-3837a11c6b73',1),
(12,'Patient with viral load without test date','SELECT p.patient_id\nFROM patient p\nWHERE p.patient_id IN\n    (SELECT person_id AS patient_id\n     FROM obs\n     WHERE person_id = p.patient_id\n       AND concept_id IN (856)\n     GROUP BY patient_id\n     ORDER BY obs_datetime DESC)\n  AND p.patient_id NOT IN\n    (SELECT person_id AS patient_id\n     FROM obs\n     WHERE concept_id = 159951\n     GROUP BY patient_id\n     ORDER BY obs_datetime DESC)','Have Viral Load Without a Result Test Date',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-28 08:43:06',1,'2020-07-15 14:56:09',0,NULL,NULL,NULL,'e4188c1d-56d8-4eb0-92a9-15d224a94ce2',1),
(13,'Patient with CD4 Ordered without Result','SELECT p.patient_id\nFROM patient p\nWHERE (((p.patient_id IN\n           (SELECT person_id patient_id\n            FROM obs\n            WHERE person_id = p.patient_id\n              AND concept_id =165731\n            GROUP BY person_id\n            HAVING max(obs_datetime)))\n        AND (p.patient_id NOT IN\n               (SELECT person_id patient_id\n                FROM obs\n                WHERE person_id = p.patient_id\n                  AND concept_id = 5497\n                GROUP BY person_id\n                HAVING max(obs_datetime))))\n       OR ((p.patient_id IN\n              (SELECT person_id patient_id\n               FROM obs\n               WHERE person_id = p.patient_id\n                 AND concept_id = 165748\n               GROUP BY person_id\n               HAVING max(obs_datetime)))\n           AND (p.patient_id NOT IN\n                  (SELECT person_id patient_id\n                   FROM obs\n                   WHERE person_id = p.patient_id\n                     AND concept_id = 730\n                   GROUP BY person_id\n                   HAVING max(obs_datetime)))))\n  AND p.patient_id IN\n    (SELECT e.patient_id\n     FROM encounter e\n     WHERE p.patient_id = e.patient_id\n       AND e.encounter_type = 11)','Have CD4 Ordered Without CD4 Result',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-28 09:01:46',1,'2020-07-15 14:55:38',0,NULL,NULL,NULL,'5c1fc5fe-7b19-4937-a893-bcbba4202b9d',1),
(14,'Inactive Patient with no documented exit reason','SELECT p.patient_id\nFROM patient p\nWHERE (\n         (SELECT (TIMESTAMPDIFF(DAY, value_datetime, curdate()))\n          FROM obs\n          WHERE person_id = p.patient_id\n            AND concept_id IN (164506,\n                               164513,\n                               165702,\n                               164507,\n                               164514,\n                               165703)\n          HAVING max(obs_datetime)) +\n         (SELECT value_numeric\n          FROM obs\n          WHERE person_id = p.patient_id\n            AND concept_id = 159368\n          HAVING max(obs_datetime))) > 28\n  AND\n    (SELECT value_coded\n     FROM obs\n     WHERE person_id = p.patient_id\n       AND concept_id = 165470\n     HAVING max(obs_datetime)) IS NULL\n  AND p.patient_id IN\n    (SELECT e.patient_id\n     FROM encounter e\n     WHERE p.patient_id = e.patient_id\n       AND e.encounter_type IN (14,\n                                15))','Inactive Patient With No Documented Exit Reason',1,'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',NULL,1,'2019-09-28 09:24:01',1,'2020-07-15 14:55:01',0,NULL,NULL,NULL,'847b79b2-3448-4950-81d4-328b0af2044d',1);